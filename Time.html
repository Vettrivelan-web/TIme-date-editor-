<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Date Editor (Short)</title>
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
    <style>
        :root { --primary: #007bff; --secondary: #28a745; --light: #f8f9fa; --dark: #343a40; --white: #fff; --border: #ccc; }
        body { font-family: sans-serif; background: var(--light); display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; color: var(--dark); }
        .container { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; gap: 20px; max-width: 500px; width: 95%; }
        h1 { margin-bottom: 1rem; font-size: 1.5em; }
        label, button { display: block; text-align: center; }
        button, .btn-like { background-color: var(--primary); color: var(--white); padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; text-decoration: none; }
        button:hover, .btn-like:hover { background-color: #0056b3; }
        #pInput { display: none; }
        #imgPreview { max-width: 100%; max-height: 250px; margin-top: 15px; border: 1px solid var(--border); border-radius: 4px; display: none; }
        #dtInput { padding: 8px; border: 1px solid var(--border); border-radius: 4px; margin-top: 5px; width: calc(100% - 18px); max-width: 250px; }
        #sBtn { background-color: var(--secondary); margin-top: 15px; padding: 12px 25px; font-size: 1.05em; }
        #sBtn:hover { background-color: #218838; }
        #sBtn:disabled { background-color: #aaa; cursor: not-allowed; }
        #statusEl { margin-top: 15px; font-weight: bold; min-height: 1.2em; font-size: 0.9em; }
        #dlLink { background-color: #17a2b8; margin-top: 10px; display: none; }
        #dlLink:hover { background-color: #138496; }
        .error { color: red; } .success { color: green; } .processing { color: blue; } .warning { color: orange;}
    </style>
</head>
<body>
    <h1>Photo Date Editor</h1>
    <div class="container">
        <label for="pInput" class="btn-like">Upload Photo</label>
        <input type="file" id="pInput" accept="image/jpeg, image/png, image/webp">
        <p id="fName" style="font-size: 0.85em; margin-top: 5px;">No file selected.</p>
        <img id="imgPreview" src="#" alt="Preview" />

        <label for="dtInput" style="margin-top:10px;">Select New Date & Time:</label>
        <input type="datetime-local" id="dtInput">
        <button id="sBtn" disabled>Save & Download</button>

        <p id="statusEl"></p>
        <a id="dlLink" class="btn-like"></a>
    </div>

    <script>
        const pInput = document.getElementById('pInput');
        const fName = document.getElementById('fName');
        const imgPreview = document.getElementById('imgPreview');
        const dtInput = document.getElementById('dtInput');
        const sBtn = document.getElementById('sBtn');
        const statusEl = document.getElementById('statusEl');
        const dlLink = document.getElementById('dlLink');

        let imgDataURL = null, originalFName = 'image.jpg', originalFType = 'image/jpeg';

        const setStatus = (msg, type = 'info') => { statusEl.textContent = msg; statusEl.className = type; };
        const checkEnableBtn = () => { sBtn.disabled = !(imgDataURL && dtInput.value); };

        const resetUI = (full = true) => {
            fName.textContent = 'No file selected.';
            imgPreview.style.display = 'none';
            imgPreview.src = "#";
            imgDataURL = null;
            sBtn.disabled = true;
            pInput.value = '';
            dlLink.style.display = 'none';
            dlLink.removeAttribute('href');
            dlLink.removeAttribute('download');
            if (full) { dtInput.value = ''; setStatus(''); }
        };

        pInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            setStatus('');
            if (!file) { resetUI(false); return; }

            originalFType = file.type;
            if (!['image/jpeg', 'image/png', 'image/webp'].includes(originalFType)) {
                setStatus('Please select JPEG, PNG, or WebP file.', 'error'); resetUI(); return;
            }
            if (originalFType !== 'image/jpeg') setStatus('Note: EXIF works best for JPEG.', 'warning');

            originalFName = file.name;
            fName.textContent = `Selected: ${originalFName}`;
            dlLink.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (ev) => {
                imgDataURL = ev.target.result;
                imgPreview.src = imgDataURL;
                imgPreview.style.display = 'block';
                checkEnableBtn();
            };
            reader.onerror = () => { setStatus('Cannot read file.', 'error'); resetUI(); };
            reader.readAsDataURL(file);
        });

        dtInput.addEventListener('change', checkEnableBtn);

        sBtn.addEventListener('click', () => {
            if (!imgDataURL || !dtInput.value) { setStatus('Photo and Date/Time required.', 'error'); return; }
            setStatus('Processing...', 'processing');
            dlLink.style.display = 'none';
            sBtn.disabled = true;

            processImage(imgDataURL, dtInput.value)
                .then(({ finalDataUrl, finalFileName }) => {
                    dlLink.href = finalDataUrl;
                    dlLink.download = finalFileName;
                    dlLink.textContent = `Download Modified (${finalFileName.substring(0,15)}...)`; // Shorter text
                    dlLink.style.display = 'inline-block';
                    setStatus('Success! Ready to download.', 'success');
                })
                .catch(err => { setStatus(`Error: ${err.message}`, 'error'); dlLink.style.display = 'none'; })
                .finally(() => checkEnableBtn());
        });

        function processImage(imageDataUrl, dateTimeString) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        const newDate = new Date(dateTimeString);
                        if (isNaN(newDate)) throw new Error("Invalid Date/Time.");

                        // Display format (Short)
                        const dispDT = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')} ${String(newDate.getHours()).padStart(2, '0')}:${String(newDate.getMinutes()).padStart(2, '0')}`;
                        const pad = Math.max(8, Math.min(canvas.width, canvas.height) * 0.015);
                        const fSize = Math.max(10, Math.min(canvas.width, canvas.height) * 0.025);

                        ctx.font = `bold ${fSize}px sans-serif`; ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.8)'; ctx.shadowBlur = fSize * 0.15;
                        ctx.shadowOffsetX = 1; ctx.shadowOffsetY = 1;
                        ctx.fillText(dispDT, canvas.width - pad, canvas.height - pad);

                        const outMime = 'image/jpeg'; // Always output JPEG for EXIF
                        const canvasDataUrl = canvas.toDataURL(outMime, 0.9);

                        // EXIF Data (Short)
                        const y = newDate.getFullYear(), mo = String(newDate.getMonth()+1).padStart(2,'0'), d = String(newDate.getDate()).padStart(2,'0');
                        const h = String(newDate.getHours()).padStart(2,'0'), m = String(newDate.getMinutes()).padStart(2,'0'), s = String(newDate.getSeconds()).padStart(2,'0');
                        const exifDT = `${y}:${mo}:${d} ${h}:${m}:${s}`;
                        const exifObj = {"0th": {[piexif.ImageIFD.DateTime]: exifDT}, "Exif": {[piexif.ExifIFD.DateTimeOriginal]: exifDT, [piexif.ExifIFD.DateTimeDigitized]: exifDT}, "GPS": {}};
                        const exifBytes = piexif.dump(exifObj);
                        const finalDataUrl = piexif.insert(exifBytes, canvasDataUrl);

                        const tsSuffix = newDate.toISOString().slice(0,19).replace(/[-T:]/g, ''); // YYYYMMDDHHMMSS
                        const baseName = originalFName.substring(0, originalFName.lastIndexOf('.')) || originalFName;
                        const finalFileName = `${baseName}_${tsSuffix}.jpg`; // Ensure .jpg extension

                        resolve({ finalDataUrl, finalFileName });

                    } catch (error) { reject(error); }
                };
                img.onerror = () => reject(new Error("Cannot load image on canvas."));
                img.src = imageDataUrl;
            });
        }
        resetUI(); // Initial setup
    </script>
</body>
</html>